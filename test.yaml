resource.customizations.actions.batch_Job: |
  discovery.lua: |
    actions = {}
    if obj.metadata.labels and obj.metadata.labels["argocd.custom-action/retryable"] == "true" then
      actions["restart"] = {}
    end
    return actions
  definitions:
    - name: restart
      title: Restart Job
      message: Restarting Job...
      icon: replay
  action.lua: |
    local os = require("os")
    local result = {}
    local function deepCopy(orig) if type(orig) ~= 'table' then return orig end; local copy = {}; for k, v in pairs(orig) do copy[deepCopy(k)] = deepCopy(v) end; return copy end
    if obj then
      local newJob = { apiVersion = "batch/v1", kind = "Job", metadata = {}, spec = deepCopy(obj.spec) }
      local name = obj.metadata.name; if string.len(name) > 40 then name = string.sub(name, 1, 40) end
      newJob.metadata.name = name .. "-rst-" .. os.time()
      newJob.metadata.namespace = obj.metadata.namespace
      newJob.metadata.labels = deepCopy(obj.metadata.labels or {})
      newJob.metadata.labels["argocd-action"] = "restarted-job"
      
      if obj.metadata.annotations then
        newJob.metadata.annotations = deepCopy(obj.metadata.annotations)
        newJob.metadata.annotations["argocd.argoproj.io/hook"] = nil
        newJob.metadata.annotations["argocd.argoproj.io/tracking-id"] = nil
        newJob.metadata.annotations["kubectl.kubernetes.io/last-applied-configuration"] = nil
      end
      
      newJob.spec.selector = nil
      if newJob.spec.template and newJob.spec.template.metadata then newJob.spec.template.metadata.labels = newJob.metadata.labels end
      result[1] = { operation = "create", resource = newJob }
    end
    return result