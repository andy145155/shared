apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cm
  namespace: argocd
data:
  # Define the Custom Action for Batch/Job
  resource.customizations.actions.batch_Job: |
    discovery.lua: |
      actions = {}
      -- Only show button if the specific label exists
      if obj.metadata.labels and obj.metadata.labels["argocd.custom-action/retryable"] == "true" then
        actions["retry-verification"] = {
          ["title"] = "Retry Verification",
          ["icon"] = "fa-redo",
          ["description"] = "Creates a new copy of this job to re-run verification"
        }
      end
      return actions

    definitions:
      - name: retry-verification
        action.lua: |
          local os = require("os")
          local newJob = {}
          
          -- Copy base structure
          newJob.apiVersion = obj.apiVersion
          newJob.kind = obj.kind
          newJob.metadata = {}
          
          -- Create unique name: verification-app-retry-12345678
          newJob.metadata.name = obj.metadata.name .. "-retry-" .. os.time()
          newJob.metadata.namespace = obj.metadata.namespace
          newJob.metadata.labels = obj.metadata.labels
          newJob.metadata.annotations = obj.metadata.annotations
          
          -- Copy spec
          newJob.spec = obj.spec
          
          -- Clean up immutable fields to allow re-submission
          newJob.spec.selector = nil 
          if newJob.spec.template.metadata.labels then
            newJob.spec.template.metadata.labels["controller-uid"] = nil
          end
          
          return newJob