apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cm
  namespace: argocd
data:
  resource.customizations.actions.batch_Job: |
    discovery.lua: |
      actions = {}
      local status = obj.status or {}
      if status.failed ~= nil or status.succeeded ~= nil then
        table.insert(actions, {name = "retry", disabled = false})
      end
      return actions
    definitions:
    - name: retry
      action.lua: |
        local newJob = {}
        newJob.apiVersion = obj.apiVersion
        newJob.kind = obj.kind
        newJob.metadata = {}
        newJob.metadata.name = obj.metadata.name
        newJob.metadata.namespace = obj.metadata.namespace
        newJob.metadata.labels = obj.metadata.labels
        newJob.metadata.annotations = obj.metadata.annotations
        newJob.spec = obj.spec
        newJob.spec.selector = nil
        if newJob.spec.template and newJob.spec.template.metadata then
          newJob.spec.template.metadata.labels = {}
          if obj.spec.template.metadata.labels then
            for k, v in pairs(obj.spec.template.metadata.labels) do
              if not string.find(k, "controller-uid") and not string.find(k, "job-name") then
                newJob.spec.template.metadata.labels[k] = v
              end
            end
          end
        end
        return {{action = "delete", resource = obj}, {action = "create", resource = newJob}}