apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cm
  namespace: argocd
data:
  resource.customizations.actions.batch_Job: |
    discovery.lua: |
      local actions = {}

      local completed = false
      if obj.status ~= nil then
        if obj.status.conditions ~= nil then
          for i, condition in pairs(obj.status.conditions) do
            if condition.type == "Complete" and condition.status == "True" then
              completed = true
            elseif condition.type == "Failed" and condition.status == "True" then
              completed = true
            elseif condition.type == "FailureTarget" and condition.status == "True" then
              completed = true
            elseif condition.type == "SuccessCriteriaMet" and condition.status == "True" then
              completed = true
            end
          end
        end
      end

      if completed then
        actions["retry"] = {["iconClass"] = "fa fa-fw fa-redo", ["displayName"] = "Retry Job"}
      end

      return actions
    definitions:
      - name: retry
        action.lua: |
          local os = require("os")
          
          -- Deep copy function to properly copy nested tables
          function deepCopy(original)
            local copy
            if type(original) == 'table' then
              copy = {}
              for orig_key, orig_value in next, original, nil do
                copy[deepCopy(orig_key)] = deepCopy(orig_value)
              end
              setmetatable(copy, deepCopy(getmetatable(original)))
            else
              copy = original
            end
            return copy
          end
          
          -- Create a deep copy of the entire object
          local job = deepCopy(obj)
          
          -- Update the name with retry suffix
          job.metadata.name = obj.metadata.name .. "-retry-" .. tostring(os.time())
          
          -- Clear fields that should not be copied
          job.metadata.uid = nil
          job.metadata.resourceVersion = nil
          job.metadata.creationTimestamp = nil
          job.metadata.generation = nil
          job.metadata.managedFields = nil
          job.status = nil
          
          -- Clear selector to let k8s generate new one
          job.spec.selector = nil
          
          -- Clear controller-uid from pod template
          if job.spec.template.metadata ~= nil then
            if job.spec.template.metadata.labels ~= nil then
              job.spec.template.metadata.labels["controller-uid"] = nil
              job.spec.template.metadata.labels["batch.kubernetes.io/controller-uid"] = nil
              job.spec.template.metadata.labels["job-name"] = nil
              job.spec.template.metadata.labels["batch.kubernetes.io/job-name"] = nil
            end
          end
          
          -- Add annotation to prevent sync issues
          job.metadata.annotations = job.metadata.annotations or {}
          job.metadata.annotations["argocd.argoproj.io/compare-options"] = "IgnoreExtraneous"
          
          return {
            {
              operation = "create",
              resource = job
            }
          }
