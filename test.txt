Here is a professional, production-ready `README.md` for your project.

I have structured it to cover **Setup, Usage, and Architecture**, making it easy for your team (or future you) to onboard.

---

# External-DNS Verification Automation

A robust automated verification suite designed to validate the end-to-end integration between **Kubernetes**, **ExternalDNS**, and **AWS Route53**.

This script performs "Black Box" testing by deploying real Kubernetes resources (Service, Ingress, Istio Gateway) and verifying that the corresponding DNS records are correctly propagated toâ€”and subsequently removed fromâ€”AWS Route53.

## ğŸš€ Features

* **Smart Detection:** Automatically detects the running configuration of `external-dns` (e.g., source types, `upsert-only` mode, ownership registry) by inspecting the live Pod.
* **Idempotency:** Safe to run repeatedly. Includes robust cleanup logic to prevent "zombie" resources in K8s or Route53.
* **Fail-Safe:** Handles `SIGTERM` signals for graceful shutdown in Kubernetes/ArgoCD environments.
* **Modular Architecture:** Separation of concerns between Kubernetes logic, AWS interactions, and test orchestration.

## ğŸ“‹ Prerequisites

* **Python 3.11+**
* **Kubernetes Cluster** with `external-dns` installed.
* **AWS Credentials** with Route53 write permissions.

### Required IAM Permissions

The script requires the following AWS IAM actions on the target Hosted Zone:

* `route53:ListHostedZones`
* `route53:ListResourceRecordSets`
* `route53:ChangeResourceRecordSets`
* `route53:GetChange`

## ğŸ› ï¸ Configuration

The script is configured via Environment Variables.

| Variable | Description | Required | Default |
| --- | --- | --- | --- |
| `HOSTED_ZONE_NAME` | The domain name of the AWS Hosted Zone (e.g., `example.com.`) | **Yes** | - |
| `TEST_IMAGE` | Docker image to use for the dummy test pods | **Yes** | - |
| `EXTERNAL_DNS_EXPECTED_VERSION` | version of external-dns to verify against (e.g. `v0.13.5`) | **Yes** | - |
| `TEST_NAMESPACE` | K8s namespace where test resources will be deployed | No | `verification-external-dns` |
| `AWS_REGION` | AWS Region for Route53 calls | No | `ap-east-1` |

## ğŸ“¦ Installation & Usage

### 1. Local Development

We recommend using [uv](https://github.com/astral-sh/uv) or `pip` for dependency management.

```bash
# Install dependencies
pip install -r requirements.txt

# Export required variables
export HOSTED_ZONE_NAME="dev.example.com."
export TEST_IMAGE="nginx:alpine"
export EXTERNAL_DNS_EXPECTED_VERSION="v0.14.0"

# Run the verification
python3 main.py

```

### 2. Running as a Kubernetes Job (or ArgoCD Hook)

This script is designed to run as a **Post-Sync Hook** in ArgoCD to verify deployments automatically.

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: verify-external-dns
  annotations:
    argocd.argoproj.io/hook: PostSync
spec:
  template:
    spec:
      serviceAccountName: verification-sa # Needs RBAC to create Service/Ingress
      containers:
        - name: verifier
          image: <your-repo>/external-dns-verifier:latest
          envFrom:
            - configMapRef:
                name: verifier-config

```

## ğŸ§  How It Works

The script follows a **Setup â†’ Verify â†’ Cleanup** lifecycle for each test case (Service, Ingress, Gateway):

1. **Environment Check:** Validates K8s connectivity and AWS credentials.
2. **Discovery:** Inspects the active `external-dns` Pod to determine which sources are enabled (e.g., checks if `--source=istio-gateway` is active).
3. **Deployment:** Creates a temporary K8s resource (e.g., a Service with annotation `external-dns.alpha.kubernetes.io/hostname`).
4. **Propagation Check:** Polls AWS Route53 API until the TXT and A records appear.
5. **Teardown:** Deletes the K8s resource.
6. **Cleanup Verification:** Polls AWS Route53 to ensure records are removed (unless `upsert-only` mode is detected).

## ğŸ“‚ Project Structure

```text
.
â”œâ”€â”€ main.py                 # Entry point (Controller)
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ config.py           # Configuration & Env Var validation
â”‚   â”œâ”€â”€ k8s.py              # Kubernetes Client & Resource Management
â”‚   â”œâ”€â”€ route53.py          # AWS Boto3 logic & Pagination
â”‚   â”œâ”€â”€ external_dns.py     # Logic to inspect the running external-dns installation
â”‚   â””â”€â”€ utils.py            # Test runners and Orchestration logic
â”œâ”€â”€ manifests/              # YAML templates for test resources
â”‚   â”œâ”€â”€ service.yaml
â”‚   â”œâ”€â”€ ingress.yaml
â”‚   â””â”€â”€ gateway.yaml
â””â”€â”€ requirements.txt        # Python dependencies

```

## ğŸ¤ Contributing

1. Ensure all new logic is added to the relevant module in `lib/`.
2. Run linting before committing:
```bash
ruff check .

```