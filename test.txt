Task 1: Refactor Istio Verification Scripts & Containerize
Goal: Break the current monolithic script into isolated, portable scripts and package them into Docker images. No ArgoCD changes happen here.
Description:
Currently, our verification runs as a "Monolithic Verification" script (verification-istio job) in the af-toolkit namespace. We need to modularize this logic so it can be run independently at different stages.
This task involves extracting the specific logic for Control Plane, Ingress, and Data Plane verification into standalone scripts and containerizing them.
Scope of Work:
 * Extract Control Plane Logic: Create verify_controlplane.py (checks istiod deployment and runs istioctl analyze).
 * Extract Ingress Logic: Create check_ingress_gateway.py (verifies external connectivity).
 * Extract Data Plane Logic: Create check_mtls.py and check_retry_after.py.
 * Containerization: Create distinct Docker images (or a shared image with different entry points) containing these scripts and the necessary binaries (e.g., istioctl).
Acceptance Criteria:
 * Script Separation: The monolithic verification-istio logic is successfully split into the individual python scripts listed above.
 * Local Execution: Each script can be run independently against a cluster and returns the correct pass/fail exit codes.
 * Docker Images: A Docker image is built and pushed to the registry containing the new modular scripts and istioctl.
 * No Dependencies: The scripts do not rely on the legacy "all-in-one" job structure.
Task 2: Integrate Verification Hooks into ArgoCD
Goal: Update the ArgoCD Application manifests to trigger the containerized scripts (from Task 1) at the correct Sync Lifecycle stages.
Description:
Now that the verification logic is modularized, we need to integrate these checks into the ArgoCD pipeline to gate the upgrade process. This replaces the manual "verify at the end" flow with automated gating.
Scope of Work:
 * Stage A (Pre-Flight): Configure a PreSync hook on the istiod Application to run istioctl x precheck.
 * Stage B (Control Plane): Configure a PostSync hook on the istiod Application to run the verify_controlplane.py container.
 * Stage C (Ingress): Configure a PostSync hook on the istio-ingress Application to run the check_ingress_gateway.py container.
 * Stage D (Data Plane): Configure a PostSync hook on the sequential-restart Application to run the check_mtls.py container.
Acceptance Criteria:
 * Gating Works: If the PreSync (Precheck) fails, the sync aborts immediately (nothing is applied).
 * Control Plane Safety: If verify_controlplane.py fails, the pipeline stops before touching Ingress or Workloads.
 * Ingress Verification: check_ingress_gateway.py runs automatically after the Ingress component syncs.
 * Data Plane Verification: mTLS and proxy checks run automatically only after the workload restart job completes.
Would you like me to format these as a CSV or a specific format for you to import directly into Jira?
