Job

üìù Description
This PR introduces a new automated verification suite, verify_ingress_gateway.py, designed to run as a Kubernetes Job during the release pipeline.

The goal of this tool is to perform "Runtime Verification" of Istio configurations inside the cluster. Unlike static analysis (istioctl analyze), this script verifies that the Envoy data plane is correctly programmed, routes are active, and security policies (RBAC) are enforcing access control before we promote a release.

üöÄ Key Features
This script implements a 3-stage verification process using Pure Python (zero external dependencies like tenacity or requests):

Test A: Positive Connectivity (Routing)

Verifies that the VirtualService and Gateway are correctly wired.

Ensures the application is reachable via the Ingress Gateway using the internal ClusterIP.

Test B: Security Isolation (Wildcard Prevention)

Mechanism: Connects with a valid SNI but injects an invalid Host header (e.g., unauthorized-domain.com).

Expectation: 404 Not Found.

Why: Prevents "Host Hijacking," where a misconfigured VirtualService (e.g., accidental * wildcard) might steal traffic from other production services on the shared Gateway.

Test C: Access Control (RBAC)

Mechanism: Applies a temporary AuthorizationPolicy to the test workload.

Expectation:

Requests without a token return 403 Forbidden.

Requests with the correct token return 200 OK.

Why: Verifies that the platform correctly enforces security policies.

‚öôÔ∏è Architectural Decisions
Dependency-Free: The script uses standard library subprocess, time, and socket. This keeps the Docker image lightweight and reduces supply chain risks.

Internal Resolution: We resolve the Ingress Gateway via its ClusterIP using curl --resolve. This bypasses external DNS/LoadBalancers to ensure deterministic, fast results without "hairpinning" issues.

TLS Handling: We use curl -k to bypass certificate trust validation. This is intentional: we are testing Layer 7 Routing and Layer 4 Connectivity, not the container's root trust store or certificate expiration (which is monitored separately by cert-manager).

Robust Cleanup: Wrapped in a try...finally block to ensure all ephemeral resources (Gateway, VirtualService, AuthorizationPolicy) are deleted, even if the test fails.

üìÇ Files Added
tasks/k8s-baseline-app/istio/tests/verify_ingress_gateway.py: Main logic script.

tasks/k8s-baseline-app/istio/tests/ingress.yaml: Template for Gateway/VS resources.

tasks/k8s-baseline-app/istio/tests/auth-policy.yaml: Template for AuthorizationPolicy testing.

üß™ Testing Strategy
[x] Local Test: Ran the script against a dev cluster; verified all 3 stages pass.

[x] Failure Test: Manually broke the VirtualService config to confirm the script raises an exception and cleans up resources.

[x] Timeout Test: Verified that the custom retry logic waits for the Gateway IP allocation (up to 60s) before failing.